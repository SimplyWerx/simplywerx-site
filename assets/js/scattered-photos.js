/**
 * Scattered Photos Background Effect
 * Creates a dynamic scattered photo collage background
 */

(function() {
    'use strict';

    // Configuration
    const config = {
        photoCount: 48, // Number of photos to scatter
        minSize: 160,   // Minimum photo size in pixels
        maxSize: 320,   // Maximum photo size in pixels
        parallaxEffect: true // Enable subtle parallax on scroll
    };

    // Photo list is loaded from photo-list.js (auto-generated by Jekyll)
    const photoList = typeof PHOTO_LIST !== 'undefined' ? PHOTO_LIST : [];

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function getRandomPhotos(count) {
        const shuffled = [...photoList].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, Math.min(count, photoList.length));
    }

    function createScatteredPhotos() {
        const header = document.querySelector('header.masthead');
        if (!header) return;

        // Create container for scattered photos
        let container = document.querySelector('.scattered-photos-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'scattered-photos-container';
            header.insertBefore(container, header.firstChild);
        }

        // Clear existing photos
        container.innerHTML = '';

        // Adjust photo count based on screen size
        const isMobile = window.innerWidth <= 768;
        const photoCount = isMobile ? Math.ceil(config.photoCount/1.5) : config.photoCount;
        
        const selectedPhotos = getRandomPhotos(photoCount);
        
        // Calculate optimal grid dimensions based on photo count
        const actualPhotoCount = selectedPhotos.length;
        const cols = Math.ceil(Math.sqrt(actualPhotoCount));
        const rows = Math.ceil(actualPhotoCount / cols);
        const cellWidth = 100 / cols;
        const cellHeight = 100 / rows;
        
        selectedPhotos.forEach((photo, index) => {
            const photoElement = document.createElement('div');
            photoElement.className = 'scattered-photo';
            
            const size = getRandomInt(config.minSize, config.maxSize);
            const rotation = getRandomInt(-25, 25);
            
            // Calculate grid position for more even distribution
            const gridIndex = index % (cols * rows);
            const gridCol = gridIndex % cols;
            const gridRow = Math.floor(gridIndex / cols);
            
            // Position within grid cell with randomness for natural look
            // Start from the beginning of each grid cell and randomize position within it
            const basLeft = gridCol * cellWidth;
            const baseTop = gridRow * cellHeight;
            const offsetLeft = getRandomInt(0, cellWidth * 0.6);
            const offsetTop = getRandomInt(0, cellHeight * 0.6);
            
            const left = Math.max(1, Math.min(85, basLeft + offsetLeft));
            const top = Math.max(1, Math.min(85, baseTop + offsetTop));
            
            const delay = index * 50; // Stagger animation
            
            photoElement.style.width = `${size}px`;
            photoElement.style.height = `${size}px`;
            photoElement.style.top = `${top}%`;
            photoElement.style.left = `${left}%`;
            photoElement.style.transform = `rotate(${rotation}deg)`;
            photoElement.style.animationDelay = `${delay}ms`;
            
            const img = document.createElement('img');
            img.src = `assets/img/optimized-small/${photo}`;
            img.alt = 'Background photo';
            img.loading = 'lazy';
            
            photoElement.appendChild(img);
            container.appendChild(photoElement);
        });

        // Add parallax effect on scroll if enabled
        if (config.parallaxEffect) {
            let ticking = false;
            
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    window.requestAnimationFrame(function() {
                        const scrolled = window.pageYOffset;
                        const photos = document.querySelectorAll('.scattered-photo');
                        
                        photos.forEach((photo, index) => {
                            const speed = 0.3 + (index % 3) * 0.1;
                            const translateY = scrolled * speed;
                            const currentRotation = photo.style.transform.match(/rotate\((.+?)deg\)/)[1];
                            photo.style.transform = `translateY(${translateY}px) rotate(${currentRotation}deg)`;
                        });
                        
                        ticking = false;
                    });
                    
                    ticking = true;
                }
            });
        }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', createScatteredPhotos);
    } else {
        createScatteredPhotos();
    }

    /*
    // Refresh on window resize (debounced)
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(createScatteredPhotos, 250);
    });
    */

})();
